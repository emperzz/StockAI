# Planner 节点重构说明

## 重构概述

成功将 planner 节点中重复的 prompt 部分提取出来，作为外部常量，提高了代码的可维护性和一致性。

## 重构内容

### 1. 提取节点能力描述常量

在 `planner` 函数开始处定义了 `NODE_CAPABILITIES` 常量：

```python
# 节点能力描述常量
NODE_CAPABILITIES = """
    # 可用节点能力：
    ## trend_analyze
    - 股票技术分析：K线走势、价格趋势、技术指标计算
    - 多周期分析：日线、周线、分钟线（1分钟、5分钟、15分钟）
    - 量价关系分析：成交量与价格变化关系
    - 支撑压力位分析：关键价位识别
    - 分时走势分析：日内交易时段走势
    
    ## market_news
    - 新闻信息获取：东方财富网、百度搜索等渠道
    - 政策消息分析：政策对股市的影响
    - 公司公告解读：重大事项、财务报告等
    - 行业动态分析：行业发展趋势、竞争格局
    - 市场情绪分析：新闻对市场情绪的影响
    
    ## get_proper_concept
    - 板块清单获取：所有板块列表和实时数据
    - - 板块筛选：按涨幅、涨停股票数量等条件筛选
    - 板块重叠度分析：分析板块间股票重叠情况
    - 板块成分股分析：获取板块内股票明细
    - 涨停情况统计：板块内涨停股票统计
    
    ## analyze_leading_stocks
    - 涨停股票获取：指定日期的所有涨停股票
    - 龙头股识别：按连板次数、涨停时间等排序
    - 权重股分析：按市值、成交量等分析
    - 板块龙头分析：特定板块的龙头股识别
    - 市场总龙头分析：全市场龙头股排序
    
    ## analyze_stocks_similiarity
    - 股票基本信息获取：股票名称、主营业务、市值等
    - K线相似度计算：计算股票与龙头股的K线走势相似度
    - 主营业务相似度分析：比较股票与龙头股的主营业务相似度
    - 综合相似度排序：结合K线和主营业务相似度进行综合排序
    - 多维度相似度评估：从技术面和基本面两个维度评估相似度
    - 需要提供龙头股和需要计算的股票清单
    """
```

### 2. 更新首次规划 prompt

将原来的重复代码替换为：

```python
system_prompt = f"""
    你是一个智能任务规划器，负责分析用户需求并制定执行计划。
    {NODE_CAPABILITIES}
    
    规划要求：
    ...
```

### 3. 更新滚动规划 prompt

将原来的重复代码替换为：

```python
system_prompt = f"""
    你是一个智能任务规划器，请根据原有的任务明细和已完成的任务结果，规划后续的任务清单。
    
    # 用户需求：
    {user_input}
    
    #当前任务状态：
    {[s.model_dump() for s in current_plan]}
    
    {NODE_CAPABILITIES}
    
    规划要求：
    ...
```

## 重构效果

### 1. 代码减少
- 删除了约 70 行重复代码
- 提高了代码的简洁性

### 2. 维护性提升
- 节点能力描述集中管理
- 修改一处即可影响所有使用场景
- 减少维护成本

### 3. 一致性保证
- 两个 prompt 使用完全相同的节点能力描述
- 避免了因手动复制导致的不一致问题

### 4. 可读性改善
- 代码结构更清晰
- 重复部分一目了然
- 便于理解和维护

## 重构前后对比

### 重构前
- 两个 prompt 中都有完整的节点能力描述
- 代码重复，维护困难
- 修改需要同时更新两处

### 重构后
- 节点能力描述提取为常量
- 两个 prompt 引用同一个常量
- 修改只需更新一处

## 测试建议

建议测试以下场景：
1. 首次规划功能正常
2. 滚动规划功能正常
3. 节点能力描述显示正确
4. 所有节点都能被正确识别和调用
5. 代码运行无语法错误

## 未来优化建议

1. 可以考虑将 `NODE_CAPABILITIES` 提取到配置文件或单独的模块中
2. 可以进一步提取其他重复的 prompt 部分
3. 可以考虑使用模板引擎来管理复杂的 prompt 结构
